<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">

    <!-- Bootstrap CSS -->
    <link crossorigin="anonymous" href="./css/bootstrap.min.css" rel="stylesheet">
    <link href="./img/img.png" rel="shortcut icon">
    <link href="css/styles.css" rel="stylesheet">
    <title>Ballerina Cloud Performance</title>
</head>
<body>
<header class="jumbotron">
    <div class="container">
        <div class="row align-items-center">
            <h1 class="display-5">Ballerina Cloud Performance Stats</h1>
        </div>
    </div>
</header>

<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script crossorigin="anonymous" src="./scripts/jquery.slim.js"></script>
<script crossorigin="anonymous" src="scripts/popper.min.js"></script>
<script crossorigin="anonymous" src="scripts/bootstrap.min.js"></script>
<script src="scripts/chart.js"></script>
<script src="scripts/d3.min.js" type="text/javascript"></script>
<div class="container">
    <div class="row ">

        <div class="col-12 col-md-9">
            <form>
                <div class="form-group row">
                    <h3 class="col-12 col-md-2 col-form-label">Test Scenario </h3>
                    <select class="form-control" id="scenario" onchange="onSelectChange(this.value)">
                        <option selected="selected">h1_h1_passthrough</option>
                        <option>h1_transformation</option>
                        <option>h1c_h1c_passthrough</option>
                        <option>h1c_transformation</option>
                    </select>
                </div>
            </form>
        </div>
    </div>
    <div class="row">
        <div class="col-sm row-content">
            <div class="col-12">
                <h3>Throughput</h3>
            </div>
            <div>
                <canvas id="throughputCanvas"></canvas>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-sm row-content">
            <div class="col-12">
                <h3>Average Response Time</h3>
            </div>
            <div>
                <canvas id="averageCanvas"></canvas>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-sm row-content">
            <div class="col-12">
                <h3>Standard Deviation of Response Time</h3>
            </div>
            <div>
                <canvas id="stdDevCanvas"></canvas>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-sm row-content">
            <div class="col-12">
                <h3>99th Percentile of Response Time</h3>
            </div>
            <div>
                <canvas id="percentileCanvas"></canvas>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-sm row-content">
            <div class="col-12">
                <h3>Error Percentage</h3>
            </div>
            <div>
                <canvas id="errorCanvas"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
    // A $( document ).ready() block.
    $(document).ready(function () {
        let value = document.getElementById("scenario").value;
        onSelectChange(value)
    });

    function onSelectChange(value) {
        let url = "https://raw.githubusercontent.com/ballerina-platform/ballerina-performance-cloud/main/summary/" + value + ".csv";
        console.log(url);
        destroyCharts();
        drawCharts(url);
    }

    function drawChart(throughput_data, canvas) {
        let timeFormat = 'DD/MM/YYYY, HH:mm:ss';
        return new Chart(
            document.getElementById(canvas),
            {
                type: 'line',
                data: throughput_data,
                options: {
                    scales: {
                        xAxes: [{
                            type: "time",
                            time: {
                                format: timeFormat,
                                tooltipFormat: 'll'
                            },
                            scaleLabel: {
                                display: true,
                                labelString: 'Date'
                            }
                        }],
                    }
                }
            }
        )

    }

    let throughputChart;
    let averageChart;
    let stdDevChart;
    let percentileChart;
    let errorChart;

    function destroyCharts() {
        if (throughputChart !== undefined) {
            throughputChart.destroy();
        }
        if (averageChart !== undefined) {
            averageChart.destroy();
        }
        if (stdDevChart !== undefined) {
            stdDevChart.destroy();
        }
        if (percentileChart !== undefined) {
            percentileChart.destroy();
        }
        if (errorChart !== undefined) {
            errorChart.destroy();
        }
    }

    function extractData(stats, users, payload, attribute) {
        let coordinates = [];
        stats.filter(function (row) {
            return row['Users'] === users && row['Payload'] === payload;
        }).map(function (value) {
                let date = new Date(value['Date'] * 1000);
                coordinates.push({"x": date.toLocaleString(), "y": value[attribute].replace("%","")});
            }
        );
        return coordinates;
    }

    function getCSVData(stats, attribute) {
        let dataset = [];
        // 60 users to 1024 bytes
        let data_60_1024 = {
            label: '60 user 1024b payload (ms)',
            showLine: true,
            backgroundColor: 'rgb(99,161,255)',
            borderColor: 'rgb(99,174,255)',
            data: extractData(stats, '60', '1024', attribute)
        }
        dataset.push(data_60_1024);

        // 60 users to 50 bytes
        let data_60_50 = {
            label: '60 user 50b payload (ms)',
            showLine: true,
            backgroundColor: 'rgb(255,229,99)',
            borderColor: 'rgb(255,229,99)',
            data: extractData(stats, '60', '50', attribute),
        }
        dataset.push(data_60_50);

        // 300 users to 50 bytes
        let data_300_50 = {
            label: '300 user 50b payload (ms)',
            showLine: true,
            backgroundColor: 'rgb(128,255,99)',
            borderColor: 'rgb(154,255,99)',
            data: extractData(stats, '300', '50', attribute),
        }
        dataset.push(data_300_50);

        // 300 users to 1024 bytes
        let data_300_1024 = {
            label: '300 user 1024b payload (ms)',
            showLine: true,
            backgroundColor: 'rgb(255,99,112)',
            borderColor: 'rgb(255,99,122)',
            data: extractData(stats, '300', '1024', attribute),
        }
        dataset.push(data_300_1024);


        return {
            datasets: dataset
        };
    }

    function drawCharts(url) {

        d3.csv(url).then(function (stats) {
            //Throughput Chart
            const throughput_dataset = getCSVData(stats, 'Throughput')
            throughputChart = drawChart(throughput_dataset, 'throughputCanvas');

            // Average Chart
            const average_dataset = getCSVData(stats, 'Average');
            averageChart = drawChart(average_dataset, 'averageCanvas');

            //Standard Deviation of Response Time Chart
            const deviation_dataset = getCSVData(stats, 'Std. Dev.')
            stdDevChart = drawChart(deviation_dataset, 'stdDevCanvas')

            //99 percentile of Response Time Chart
            const percentile_dataset = getCSVData(stats, '99% Line')
            percentileChart = drawChart(percentile_dataset, "percentileCanvas");

            //Error Count Chart
            const error_dataset = getCSVData(stats, 'Error %');
            errorChart = drawChart(error_dataset, "errorCanvas");
        });
    }

</script>
</body>
</html>
